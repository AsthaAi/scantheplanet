id: SAFE-T1308
name: Token Scope Substitution
severity: P1
summary: 'Attacker substitutes limited-scope token with broader permissions, exploiting missing scope validation'
description: 'Token Scope Substitution occurs when an attacker replaces a limited-scope OAuth token with one that has
  broader permissions but the same audience, exploiting insufficient scope validation to gain elevated privileges.

  This attack targets OAuth implementations that validate tokens but fail to verify that the token scopes match
  what was originally requested or required for the operation.'
mitigations:
- SAFE-M-9
code_signals:
- id: SAFE-T1308.signal.permissive_scope
  description: Detects overly permissive scope configurations
  heuristics:
  # Wildcard or empty scopes
  - pattern: 'allowedScopes: []'
  - pattern: 'allowed_scopes: []'
  - pattern: 'scopes: []'
  - pattern: 'scope: "all"'
  - pattern: 'scope: "admin"'
  - regex: 'scope\s*[:=]\s*"\*"'
  - regex: 'scopes?\s*[:=]\s*\[\s*\]'
- id: SAFE-T1308.signal.skip_validation
  description: Detects configurations that skip validation
  heuristics:
  - pattern: 'skipScopeValidation: true'
  - pattern: 'skip_scope_validation: true'
  - pattern: 'skipScopeValidation = true'
  - pattern: 'skip_scope_validation = true'
  - pattern: 'bypassScope: true'
  - pattern: 'bypass_scope: true'
  - pattern: 'ignoreScope: true'
  - pattern: 'ignore_scope: true'
  - regex: '(skip|bypass|ignore).{0,10}scope.{0,10}true'
    flags: i
- id: SAFE-T1308.signal.unsafe_jwt
  description: Detects unsafe JWT options
  heuristics:
  - pattern: 'verify: false'
  - pattern: 'algorithms: ["none"]'
  - pattern: "algorithms: ['none']"
  - pattern: 'ignoreExpiration: true'
  - pattern: 'ignore_expiration: True'
  - pattern: 'audience: undefined'
  - pattern: 'audience: null'
  - regex: 'verify\s*:\s*false'
  - regex: 'algorithm.{0,5}none'
    flags: i
languages:
- typescript
- javascript
- python
output_schema:
  requires_mitigations: false
  allowed_status_values:
  - pass
  - fail
  - partial
  - unknown
