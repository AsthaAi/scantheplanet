import { readFileSync, writeFileSync, mkdirSync } from 'node:fs';
import { dirname, join } from 'node:path';
import { fileURLToPath } from 'node:url';

const root = join(dirname(fileURLToPath(import.meta.url)), '..');

const promptsDir = join(root, 'packages', 'contracts', 'prompts');
const readPrompt = (name) => readFileSync(join(promptsDir, name), 'utf8').trimEnd();

const systemPrompt = readPrompt('system.prompt.txt');
const batchPrompt = readPrompt('batch.prompt.txt');
const jsonPrefill = readPrompt('json.prefill.txt');

const escapeTs = (value) =>
  value
    .replace(/\\/g, '\\\\')
    .replace(/`/g, '\\`')
    .replace(/\$\{/g, '\\${');

const escapeKotlin = (value) =>
  value
    .replace(/"""/g, '\\"""')
    .replace(/\$/g, '\\$');

const tsOut = join(root, 'packages', 'core', 'src', 'prompt', 'PromptStrings.ts');
const ktOut = join(
  root,
  'packages',
  'intellij-plugin',
  'src',
  'main',
  'kotlin',
  'ai',
  'astha',
  'scantheplanet',
  'idea',
  'scanner',
  'prompt',
  'PromptStrings.kt'
);

mkdirSync(dirname(tsOut), { recursive: true });
mkdirSync(dirname(ktOut), { recursive: true });

const tsContent = `// Generated by scripts/sync-contracts.mjs. Do not edit.
export const SYSTEM_PROMPT = \`${escapeTs(systemPrompt)}\`;
export const BATCH_SYSTEM_PROMPT = \`${escapeTs(batchPrompt)}\`;
export const JSON_PREFILL = \`${escapeTs(jsonPrefill)}\`;
`;

const ktContent = `// Generated by scripts/sync-contracts.mjs. Do not edit.
package ai.astha.scantheplanet.idea.scanner.prompt

object PromptStrings {
    val SYSTEM_PROMPT: String = """${escapeKotlin(systemPrompt)}""".trimIndent()
    val BATCH_SYSTEM_PROMPT: String = """${escapeKotlin(batchPrompt)}""".trimIndent()
    val JSON_PREFILL: String = """${escapeKotlin(jsonPrefill)}"""
}
`;

writeFileSync(tsOut, tsContent, 'utf8');
writeFileSync(ktOut, ktContent, 'utf8');

console.log('Synced prompts to core and IntelliJ.');
